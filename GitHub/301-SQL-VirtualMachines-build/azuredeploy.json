{  
   "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{  
      "vmName":{  
         "defaultValue":"",
         "minLength":3,
         "type":"String",
         "metadata":{  
            "description":"Name for the Virtual Machine. Name will be iterated for each VM starting at 1"
         }
      },
      "AvailabilitySet":{  
         "defaultValue":"",
         "minLength":3,
         "type":"String",
         "metadata":{  
            "description":"Name for the AvailabilitySet."
         }
      },
      "numberOfInstances":{  
         "defaultValue":1,
         "type":"Int",
         "metadata":{  
            "Description":"Number of Azure VM to create."
         }
      },
      "localAdminUserName":{  
         "minLength":1,
         "type":"String",
         "metadata":{  
            "description":"Local Username for the Virtual Machine."
         }
      },
      "localAdminPassword":{  
         "defaultValue":"",
         "minLength":1,
         "type":"SecureString",
         "metadata":{  
            "description":"Local Password for the Virtual Machine."
         }
      },
      "domainJoinUserName":{  
         "minLength":1,
         "type":"String",
         "metadata":{  
            "description":"Account for domain joining. Example: domain\\serviceaccount"
         }
      },
      "domainJoinPassword":{  
         "minLength":1,
         "type":"SecureString",
         "metadata":{  
            "description":"Password for domain joining"
         }
      },
      "SQLServerAccount":{  
         "minLength":1,
         "type":"String",
         "metadata":{  
            "description":"SQL Server Service runas account.  Example: domain\\serviceaccount"
         }
      },
      "SQLServerPassword":{  
         "minLength":1,
         "type":"SecureString",
         "metadata":{  
            "description":"Password for domain joining"
         }
      },
      "SQLAgentAccount":{  
         "minLength":1,
         "type":"String",
         "metadata":{  
            "description":"Account to use for Running the SQL Agent Service.  Example: domain\\serviceaccount"
         }
      },
      "SQLAgentPassword":{  
         "minLength":1,
         "type":"SecureString",
         "metadata":{  
            "description":"Password for account to use for Running the SQL Agent Service."
         }
      },
      "localAdmins":{  
         "defaultValue":"",
         "type":"String",
         "metadata":{  
            "description":"Users and groups added to the local administrator group."
         }
      },
      "SQLAdmins":{  
         "defaultValue":"",
         "type":"String",
         "metadata":{  
            "description":"SQL SYS admins that can login to the Default SQL Instance installed on the VM."
         }
      },
      "StorageAccountType":{  
         "defaultValue":"Standard_LRS",
         "allowedValues":[  
            "Standard_LRS",
            "Premium_LRS",
            "StandardSSD_LRS"
         ],
         "type":"String",
         "metadata":{  
            "description":"Storage performance, Standard_LRS for standard skus and Premium_LRS for premium skus"
         }
      },
      "vmSize":{  
         "defaultValue":"Standard_D4_V2",
         "type":"String",
         "metadata":{  
            "description":"Size for the Virtual Machine. Details: https://docs.microsoft.com/en-us/azure/virtual-machines/virtual-machines-linux-sizes?toc=%2fazure%2fvirtual-machines%2flinux%2ftoc.json#standard-tier-d-series"
         }
      },
      "AcceleratedNetworking":{  
         "defaultValue":"true",
         "allowedValues":[  
            "false",
            "true"
         ],
         "type":"String",
         "metadata":{  
            "description":"Accelerated Networking can only be enabled on supported SKUs.  See https://docs.microsoft.com/en-us/azure/virtual-network/create-vm-accelerated-networking-powershell for details."
         }
      },
      "imagePublisher":{  
         "defaultValue":"MicrosoftSQLServer",
         "allowedValues":[  
            "MicrosoftSQLServer"
         ],
         "type":"String",
         "metadata":{  
            "description":"See Azure for available ImagePublisher for your Location. Sample Code: <p><a target=new href=https://msitwiki/get-imagepublisher-imageoffer-imagesku-for-arm-templates/>Get-AzureRMVMImagePublisher</a></p> Example: <p>MicrosoftSQLServer or MicrosoftWindowsServer</p>"
         }
      },
      "imageOffer":{  
         "defaultValue":"SQL2016SP1-WS2016",
         "allowedValues":[  
            "SQL2012SP3-WS2012R2",
            "SQL2014SP2-WS2012R2",
            "SQL2016-WS2012R2",
            "SQL2016SP1-WS2016",
            "SQL2016SP2-WS2016",
            "SQL2017-WS2016"
         ],
         "type":"String",
         "metadata":{  
            "description":"See Imagepulisher link for more details."
         }
      },
      "sku":{  
         "defaultValue":"Enterprise",
         "allowedValues":[  
            "Enterprise",
            "Standard"
         ],
         "minLength":1,
         "type":"String",
         "metadata":{  
            "description":"Find available skus from PowerShell, https://docs.microsoft.com/en-us/powershell/resourcemanager/azurerm.compute/v1.3.4/Get-AzureRmVMImageSku?redirectedfrom=msdn"
         }
      },
      "H_DriveSize":{  
         "defaultValue":32,
         "minValue":10,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the H drive from 10GB to 4096GB"
         }
      },
      "O_DriveSize":{  
         "defaultValue":32,
         "minValue":10,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the O drive from 10GB to 4096GB"
         }
      },
      "T_DriveSize":{  
         "defaultValue":32,
         "minValue":10,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the T drive from 10GB to 4096GB"
         }
      },
      "I_DriveSize":{  
         "defaultValue":0,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the I drive, Keeping it 0 will not create the disk"
         }
      },
      "J_DriveSize":{  
         "defaultValue":0,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the J drive, Keeping it 0 will not create the disk"
         }
      },
      "K_DriveSize":{  
         "defaultValue":0,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the K drive, Keeping it 0 will not create the disk"
         }
      },
      "L_DriveSize":{  
         "defaultValue":0,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the L drive, Keeping it 0 will not create the disk"
         }
      },
      "M_DriveSize":{  
         "defaultValue":0,
         "maxValue":4096,
         "type":"Int",
         "metadata":{  
            "description":"The size in GB for the M drive, Keeping it 0 will not create the disk"
         }
      },
      "DiskEncryption":{  
         "defaultValue":"false",
         "allowedValues":[  
            "false",
            "true"
         ],
         "type":"String",
         "metadata":{  
            "description":"Azure Disk Encryption.  See https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption-overview for details."
         }
      },
      "keyVaultName":{  
         "type":"string",
		 "defaultValue":"",
         "metadata":{  
            "description":"Name of the KeyVault to place the volume encryption key"
         }
      },
      "keyVaultResourceGroup":{  
         "type":"string",
		 "defaultValue":"",
         "metadata":{  
            "description":"Resource group of the KeyVault"
         }
      },
      "Domain":{  
         "type":"String",
         "metadata":{  
            "description":"The FQDN of the AD domain.  Important! Administrative access to servers at Microsoft may require the use of Secure Admin Workstation SAW.  Details at http://aka.ms/SAWfaq"
         }
      },
      "ouPath": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "The Organizational Unit the VM will join"
        }
      },
      "virtualNetwork":{  
         "defaultValue":"",
         "type":"String",
         "metadata":{  
            "description":"Name for the VirtualNetwork"
         }
      },
      "vnetResourceGroup":{  
         "type":"String",
         "metadata":{  
            "description":"Name for the Resource Group that contains VirtualNetwork."
         }
      },
      "subnetName":{  
         "defaultValue":"Subnet-1",
         "type":"String",
         "metadata":{  
            "description":"Name for the subnet"
         }
      },
      "bootDiagnosticsStorageaccount":{  
         "defaultValue":"",
         "type":"String",
         "metadata":{  
            "description":"Name of the storage account for Boot diagnostics, If it is kept blank a new storage account will be created"
         }
      }
   },
   "variables":{  
      "apiVersion":"2015-01-01",
      "branch":"master",
      "SASToken":"",
      "PullServerRegistrationKey":"",
      "PullServerRegistrationURI":"",
      "NestedBaseURL":"[concat('https://raw.githubusercontent.com/Microsoft/MSITARM/',variables('branch'))]",
      "scriptsURL":"[concat(variables('NestedBaseURL'),'/all-scripts/')]",
      "nestedURL":"[concat(variables('NestedBaseURL'),'/all-nested/')]",
      "createVMtemplate":"[concat('template-VirtualMachines.json',variables('SASToken'))]",
      "configurePullTemplate":"[concat('template-ConfigureDscPull.json',variables('SASToken'))]",
      "TelemetryCreateLogTemplate":"[concat('template-CreateTelemetryLog.json',variables('SASToken'))]",
      "TelemetryAddLogTemplate":"[concat('template-AddTelemetryLog.json',variables('SASToken'))]",
      "Standard_LRS":{  
         "DiskConfigValue":"SQLStd"
      },
      "Premium_LRS":{  
         "DiskConfigValue":"SQLPrem"
      },
      "StandardSSD_LRS":{  
         "DiskConfigValue":"SQLStdSSD"
      },
      "DiskConfig":"[variables(parameters('StorageAccountType')).DiskConfigValue]",
      "Role":"[substring(variables('DiskConfig'),0,3)]",
      "CreateVMUrl":"[concat(variables('nestedURL'),variables('createVMtemplate'))]",
      "AttachVMtoPullServerURL":"[concat(variables('nestedURL'),variables('configurePullTemplate'))]",
      "BuildMachineRoleURL":"[concat(variables('nestedURL'),'template-Build',variables('Role'), '.json',variables('SASToken'))]",
      "TelemetryCreateLogDetailsTemplateUrl":"[concat(variables('nestedURL'),variables('TelemetryCreateLogTemplate'))]",
      "TelemetryAddLogTemplateUrl":"[concat(variables('nestedURL'),variables('TelemetryAddLogTemplate'))]",
      "createADEtemplate":"[concat('template-ADE.json',variables('SASToken'))]",
      "CreateADEUrl":"[concat(variables('nestedURL'),variables('createADEtemplate'))]",
      "bootdiagSA":"[toLower(if(equals(parameters('bootDiagnosticsStorageaccount'),''),concat(parameters('vmName'),'bdgsa'), parameters('bootDiagnosticsStorageaccount')))]",
      "AzureAutomation":{  
         "RegistrationKey":"[variables('PullServerRegistrationKey')]",
         "registrationUrl":"[variables('PullServerRegistrationURI')]",
         "configurationFunction":"UpdateLCMforAAPull.ps1\\ConfigureLCMforAAPull",
         "timestamp":"1/1/2016"
      }
   },
   "resources":[  
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"CreateTelemetryDeploymentId",
         "apiVersion":"2015-01-01",
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('TelemetryCreateLogDetailsTemplateUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "UserName":{  
                  "value":"[parameters('domainJoinUserName')]"
               },
               "NumberOfVMs":{  
                  "value":"[parameters('numberOfInstances')]"
               },
               "TemplateName":{  
                  "value":"301-SQL-VirtualMachines-build"
               },
               "InvokedBy":{  
                  "value":"CSEOTemplate"
               },
               "branch":{  
                  "value":"[variables('branch')]"
               }
            }
         }
      },
      {  
         "type":"Microsoft.Storage/storageAccounts",
         "name":"[variables('bootdiagSA')]",
         "apiVersion":"2018-07-01",
         "location":"[resourceGroup().location]",
         "properties":{  
            "accessTier":"Hot",
            "supportsHttpsTrafficOnly":true
         },
         "dependsOn":[  

         ],
         "sku":{  
            "name":"Standard_LRS"
         },
         "kind":"StorageV2"
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),'-CreateVM')]",
         "apiVersion":"2015-01-01",
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('CreateVMUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "localAdminUserName":{  
                  "value":"[parameters('localAdminUserName')]"
               },
               "localAdminPassword":{  
                  "value":"[parameters('localAdminPassword')]"
               },
               "domainJoinUserName":{  
                  "value":"[parameters('domainJoinUserName')]"
               },
               "domainJoinPassword":{  
                  "value":"[parameters('domainJoinPassword')]"
               },
               "vmName":{  
                  "value":"[parameters('vmName')]"
               },
               "AvailabilitySet":{  
                  "value":"[parameters('AvailabilitySet')]"
               },
               "StorageAccountType":{  
                  "value":"[parameters('StorageAccountType')]"
               },
               "DiskConfig":{  
                  "value":"[variables('DiskConfig')]"
               },
               "vmSize":{  
                  "value":"[parameters('vmSize')]"
               },
               "H_DriveSize":{  
                  "value":"[parameters('H_DriveSize')]"
               },
               "O_DriveSize":{  
                  "value":"[parameters('O_DriveSize')]"
               },
               "T_DriveSize":{  
                  "value":"[parameters('T_DriveSize')]"
               },
               "I_DriveSize":{  
                  "value":"[parameters('I_DriveSize')]"
               },
               "J_DriveSize":{  
                  "value":"[parameters('J_DriveSize')]"
               },
               "K_DriveSize":{  
                  "value":"[parameters('K_DriveSize')]"
               },
               "L_DriveSize":{  
                  "value":"[parameters('L_DriveSize')]"
               },
               "M_DriveSize":{  
                  "value":"[parameters('M_DriveSize')]"
               },
               "AcceleratedNetworking":{  
                  "value":"[parameters('AcceleratedNetworking')]"
               },
               "numberOfInstances":{  
                  "value":"[parameters('numberOfInstances')]"
               },
               "imagePublisher":{  
                  "value":"[parameters('imagePublisher')]"
               },
               "imageOffer":{  
                  "value":"[parameters('imageOffer')]"
               },
               "sku":{  
                  "value":"[parameters('sku')]"
               },
               "domainName":{  
                  "value":"[parameters('Domain')]"
               },
               "localAdmins":{  
                  "value":"[parameters('localAdmins')]"
               },
               "SQLAdmins":{  
                  "value":"[parameters('SQLAdmins')]"
               },
               "virtualNetwork":{  
                  "value":"[parameters('virtualNetwork')]"
               },
               "vnetResourceGroup":{  
                  "value":"[parameters('vnetResourceGroup')]"
               },
               "subnetName":{  
                  "value":"[parameters('subnetName')]"
               },
              "ouPath": {
                "value": "[parameters('OUPath')]"
              },
               "NestedBaseURL":{  
                  "value":"[variables('NestedBaseURL')]"
               },
               "SASToken":{  
                  "value":"[variables('SASToken')]"
               },
               "bootdiagSA":{  
                  "value":"[variables('bootdiagSA')]"
               }
            }
         },
         "dependsOn":[  
            "[concat('Microsoft.Storage/storageAccounts/', variables('bootdiagSA'))]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-BuildMachineRole-',variables('Role'))]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"BuildMachineRoleLoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('BuildMachineRoleURL')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "vmName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "DiskConfig":{  
                  "value":"[variables('DiskConfig')]"
               },
               "vmSize":{  
                  "value":"[parameters('vmSize')]"
               },
               "SQLServerAccount":{  
                  "value":"[parameters('SQLServerAccount')]"
               },
               "SQLServerPassword":{  
                  "value":"[parameters('SQLServerPassword')]"
               },
               "SQLAgentAccount":{  
                  "value":"[parameters('SQLAgentAccount')]"
               },
               "SQLAgentPassword":{  
                  "value":"[parameters('SQLAgentPassword')]"
               },
               "SQLAdmin":{  
                  "value":"[parameters('domainJoinUserName')]"
               },
               "SQLAdminPwd":{  
                  "value":"[parameters('domainJoinPassword')]"
               },
               "NestedBaseURL":{  
                  "value":"[variables('NestedBaseURL')]"
               },
               "SASToken":{  
                  "value":"[variables('SASToken')]"
               }
            }
         },
         "dependsOn":[  
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'), '-CreateVM')]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-AttachVMtoPullServer')]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"AttachVMtoPullServerLoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('AttachVMtoPullServerURL')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "vmName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "RegistrationKey":{  
                  "value":"[variables('AzureAutomation').RegistrationKey]"
               },
               "registrationUrl":{  
                  "value":"[variables('AzureAutomation').registrationUrl]"
               },
               "timestamp":{  
                  "value":"[variables('AzureAutomation').timestamp]"
               },
               "vNetRG":{  
                  "value":"[parameters('vnetResourceGroup')]"
               },
               "NestedBaseURL":{  
                  "value":"[variables('NestedBaseURL')]"
               },
               "SASToken":{  
                  "value":"[variables('SASToken')]"
               }
            }
         },
         "dependsOn":[  
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-BuildMachineRole-',variables('Role'))]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "condition":"[equals(parameters('DiskEncryption'), 'true')]",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-ADE')]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"ADELoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('CreateADEUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "vmName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "keyVaultName":{  
                  "value":"[parameters('keyVaultName')]"
               },
               "keyVaultResourceGroup":{  
                  "value":"[parameters('keyVaultResourceGroup')]"
               }
            }
         },
         "dependsOn":[  
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'), '-CreateVM')]",
			"BuildMachineRoleLoop"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),'-CreateVM','-LogSuccess')]",
         "apiVersion":"2015-01-01",
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('TelemetryAddLogTemplateUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "TelemetryID":{  
                  "value":"[reference('CreateTelemetryDeploymentId').outputs.TelemetryID.value]"
               },
               "TemplateName":{  
                  "value":"[variables('createVMtemplate')]"
               },
               "ResourceName":{  
                  "value":"[parameters('vmName')]"
               },
               "Logtype":{  
                  "value":"StatusLog"
               },
               "Status":{  
                  "value":"Success"
               },
               "ResourceType":{  
                  "value":"LinkedTemplate"
               },
               "branch":{  
                  "value":"[variables('branch')]"
               }
            }
         },
         "dependsOn":[  
            "Microsoft.Resources/deployments/CreateTelemetryDeploymentId",
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'),'-CreateVM')]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-BuildMachineRole-',variables('Role'),'-LogSuccess')]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"LogBuildMachineRoleLoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('TelemetryAddLogTemplateUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "TelemetryID":{  
                  "value":"[reference('CreateTelemetryDeploymentId').outputs.TelemetryID.value]"
               },
               "TemplateName":{  
                  "value":"[concat('template-Build',variables('Role'), '.json')]"
               },
               "ResourceName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "Logtype":{  
                  "value":"StatusLog"
               },
               "Status":{  
                  "value":"Success"
               },
               "ResourceType":{  
                  "value":"LinkedTemplate"
               },
               "branch":{  
                  "value":"[variables('branch')]"
               }
            }
         },
         "dependsOn":[  
            "Microsoft.Resources/deployments/CreateTelemetryDeploymentId",
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-BuildMachineRole-',variables('Role'))]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-AttachPullServer-LogSuccess')]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"AttachVMtoPullServerLogLoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('TelemetryAddLogTemplateUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "TelemetryID":{  
                  "value":"[reference('CreateTelemetryDeploymentId').outputs.TelemetryID.value]"
               },
               "TemplateName":{  
                  "value":"[variables('configurePullTemplate')]"
               },
               "ResourceName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "Logtype":{  
                  "value":"StatusLog"
               },
               "Status":{  
                  "value":"Success"
               },
               "ResourceType":{  
                  "value":"LinkedTemplate"
               },
               "branch":{  
                  "value":"[variables('branch')]"
               }
            }
         },
         "dependsOn":[  
            "Microsoft.Resources/deployments/CreateTelemetryDeploymentId",
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-AttachVMtoPullServer')]"
         ]
      },
      {  
         "type":"Microsoft.Resources/deployments",
         "condition":"[equals(parameters('DiskEncryption'), 'true')]",
         "name":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-ADE-LogSuccess')]",
         "apiVersion":"2015-01-01",
         "copy":{  
            "name":"ADELogLoop",
            "count":"[parameters('numberOfInstances')]"
         },
         "properties":{  
            "mode":"Incremental",
            "templateLink":{  
               "uri":"[variables('TelemetryAddLogTemplateUrl')]",
               "contentVersion":"1.0.0.0"
            },
            "parameters":{  
               "TelemetryID":{  
                  "value":"[reference('CreateTelemetryDeploymentId').outputs.TelemetryID.value]"
               },
               "TemplateName":{  
                  "value":"[variables('createADEtemplate')]"
               },
               "ResourceName":{  
                  "value":"[concat(parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)))]"
               },
               "Logtype":{  
                  "value":"StatusLog"
               },
               "Status":{  
                  "value":"Success"
               },
               "ResourceType":{  
                  "value":"LinkedTemplate"
               },
               "branch":{  
                  "value":"[variables('branch')]"
               }
            }
         },
         "dependsOn":[  
            "Microsoft.Resources/deployments/CreateTelemetryDeploymentId",
            "[concat('Microsoft.Resources/deployments/',parameters('vmName'),if(equals(parameters('numberOfInstances'),1),'', copyindex(1)),'-ADE')]"
         ]
      }
   ]
}